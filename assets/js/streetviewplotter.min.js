var APP;APP=function(a){var b=this;b.apiKey=a||null,b.origin={lat:51.526771,lng:-.074334},b.target={lat:51.526771,lng:-.074334},b.computeHeading=google.maps.geometry.spherical.computeHeading,b.geocoder=null,b.map=null,b.markers=[],b.frames=[],b.frameRate=12,b.player={instance:null,timeout:1e3/b.frameRate,currentFrame:null,frames:[]},b.minFrameSize=5e3,b.__construct=function(){b.log("Starting up"),b.directionService=new google.maps.DirectionsService,b.geocoder=new google.maps.Geocoder,b.log("Creating map and adding event listeners");var a={zoom:17,disableDoubleClickZoom:!0,center:new google.maps.LatLng(b.origin.lat,b.origin.lng)};b.map=new google.maps.Map(document.getElementById("map-canvas"),a),google.maps.event.addListener(b.map,"center_changed",function(){b.updateCenterCoordinates()}),google.maps.event.addListener(b.map,"click",function(){b.placeMarker()}),b.updateCenterCoordinates(),b.setCenterAsTarget(),b.setApiKey(),$("#map-searcher input").on("keyup",function(a){var c=$(this).val().trim();c.length&&13===a.which&&b.centerMap(c)}),$("#action-set-target").on("click",function(){b.setCenterAsTarget()}),$("#map-crosshair").on("click",function(){b.placeMarker()}),$("#action-export-data").on("click",function(){$(this).hasClass("disabled")||b.exportData()}),$("#action-export-frames").on("click",function(){$(this).hasClass("disabled")||b.exportFrames()}),$("#action-import-data").on("click",function(){$(this).hasClass("disabled")||b.importData()}),$("#action-clear-frames").on("click",function(){$(this).hasClass("disabled")||b.clearFrames()}),$("#action-preview").on("click",function(){$(this).hasClass("disabled")||b.buildAnimation()}),$("#action-player-stop").on("click",function(){$(this).hasClass("disabled")||b.playerStop()}),$("#param-api-key").on("blur",function(){b.setApiKey($(this).val().trim())}),$("#frames").on("click",".action-delete",function(){var a=$(this).data("frame-number");b.deleteFrame(a)}),$("#frames").on("blur","td.fov input, td.pitch input",function(){var a=$(this).closest("tr").data("frame-number"),c=b.frames[a],d=parseInt($("#frame-number-"+a+" td.pitch input").val(),10),e=parseInt($("#frame-number-"+a+" td.fov input").val(),10),f=b.computeHeading(new google.maps.LatLng(c.lat,c.lng),new google.maps.LatLng(b.target.lat,b.target.lng)),g=b.getImgUrl(100,75,c.lat,c.lng,f,d,e);$("#frame-number-"+a+" td.preview img").attr("src",g)})},b.centerMap=function(a){b.log("Centering map: "+a),b.getCoordinatesFromPostcode(a).done(function(a){b.log("Reveived new coordinates, centering map"),b.map.setCenter(a)}).fail(function(){b.log("Failed to get coordinates"),b.dialog("failed to get coordinates","Centering failed")})},b.setCenterAsTarget=function(){b.log("Setting centre of map as target"),b.target.lat=b.map.getCenter().lat(),b.target.lng=b.map.getCenter().lng(),$("#param-target-lat").val(b.target.lat),$("#param-target-lng").val(b.target.lng),b.rebuildFrameList()},b.updateCenterCoordinates=function(){b.log("Updating displayed coordinates for map centre"),$("#map-center-coordinates .lat").text(b.map.getCenter().lat()),$("#map-center-coordinates .lng").text(b.map.getCenter().lng())},b.exportData=function(a){b.log("Exporting data"),a=a||!1;var c={},d={},e=null,f=parseInt($("#param-pitch").val(),10),g=parseInt($("#param-fov").val(),10),h=parseInt($("#param-frame-width").val(),10),i=parseInt($("#param-frame-height").val(),10);c.target=b.target,c.pitch=f,c.fov=g,c.width=h,c.height=i,c.frames=[];for(var j=0;j<b.frames.length;j++)d={lat:b.frames[j].lat,lng:b.frames[j].lng,pitch:parseInt($("#frame-number-"+j+" td.pitch input").val(),10)||f,fov:parseInt($("#frame-number-"+j+"  td.fov input").val(),10)||g},e=b.computeHeading(new google.maps.LatLng(d.lat,d.lng),new google.maps.LatLng(b.target.lat,b.target.lng)),d.url=b.getImgUrl(h,i,d.lat,d.lng,e,d.pitch,d.fov),c.frames.push(d);return a?c:void $("#export-target").val(JSON.stringify(c,null,"	"))},b.exportFrames=function(a){b.log("Exporting frames");for(var c=b.exportData(!0),d=[],e=0;e<c.frames.length;e++)d.push(c.frames[e].url);return a?d:void $("#export-target").val(JSON.stringify(d,null,"	"))},b.importData=function(){b.log("Importing data");var a=$("#export-target").val().trim();if(a.length)try{a=JSON.parse(a),$("#param-target-lat").val(a.target.lat),$("#param-target-lng").val(a.target.lng),$("#param-pitch").val(a.pitch),$("#param-fov").val(a.fov),$("#param-frame-width").val(a.width),$("#param-frame-height").val(a.height),b.clearFrames(),b.map.setCenter(a.target),b.setCenterAsTarget();for(var c=0;c<a.frames.length;c++)b.markers.push(new google.maps.Marker({position:new google.maps.LatLng(a.frames[c].lat,a.frames[c].lng),map:b.map})),b.frames.push({lat:a.frames[c].lat,lng:a.frames[c].lng,pitch:a.frames[c].pitch||a.pitch,fov:a.frames[c].fov||a.fov});b.rebuildFrameList(),b.log("Import completed successfully"),b.dialog("Import completed successfully","Import OK")}catch(d){b.log("Failed to import: Bad data - "+d.message),b.dialog("Bad data - "+d.message,"Failed to import")}else b.log("Failed to import: Missing data"),b.dialog("Missing data","Failed to import")},b.placeMarker=function(){b.log("Placing marker");var a=b.map.getCenter().lat(),c=b.map.getCenter().lng(),d=parseInt($("#param-pitch").val(),10),e=parseInt($("#param-fov").val(),10);b.markers.push(new google.maps.Marker({position:new google.maps.LatLng(a,c),map:b.map})),b.frames.push({lat:a,lng:c,pitch:d,fov:e}),b.rebuildFrameList()},b.deleteFrame=function(a){b.log("Deleting frame #"+a),b.markers[a].setMap(null),b.markers.splice(a,1),b.frames.splice(a,1),b.rebuildFrameList()},b.clearFrames=function(){b.log("Clearing frames and markers");for(var a=b.markers.length-1;a>=0;a--)b.markers[a].setMap(null);b.markers=[],b.frames=[],b.rebuildFrameList()},b.rebuildFrameList=function(){b.log("Rebuilding frames list"),$("#frames tbody").empty();for(var a,c,d,e,f,g,h,i,j,k,l,m,n,o,p=0;p<b.frames.length;p++)n=b.computeHeading(new google.maps.LatLng(b.frames[p].lat,b.frames[p].lng),new google.maps.LatLng(b.target.lat,b.target.lng)),o=b.getImgUrl(100,75,b.frames[p].lat,b.frames[p].lng,n,b.frames[p].pitch,b.frames[p].fov),c=$("<td>").addClass("number").text(p),d=$("<td>").addClass("lat").text(b.frames[p].lat),e=$("<td>").addClass("lng").text(b.frames[p].lng),f=$("<td>").addClass("pitch"),j=$("<input>").val(b.frames[p].pitch),g=$("<td>").addClass("fov"),k=$("<input>").val(b.frames[p].fov),h=$("<td>").addClass("preview"),l=$("<img>").attr("src",o),i=$("<td>").addClass("action"),m=$("<button>").addClass("action-delete").data("frame-number",p).text("Delete"),a=$("<tr>").attr("id","frame-number-"+p).data("frame-number",p).append(c).append(d).append(e).append(f.append(j)).append(g.append(k)).append(h.append(l)).append(i.append(m)),$("#frames tbody").append(a)},b.buildAnimation=function(){b.log("Previewing animation"),b.playerStop(),$("#player-canvas").addClass("loading"),$("#action-preview").addClass("disabled"),$("#action-export-data").addClass("disabled"),$("#action-export-frames").addClass("disabled"),$("#action-import-data").addClass("disabled"),$("#action-clear-frames").addClass("disabled");var a=b.exportData(!0),c=$.extend(!0,{},a);c.frames.length?(b.log("Preloading "+c.frames.length+" frames"),b.loadFramesSequentially(c.frames,function(){b.log("Finished pre-loading"),b.playerPlay(a.frames),$("#player-canvas").removeClass("loading"),$("#action-preview").removeClass("disabled"),$("#action-export-data").removeClass("disabled"),$("#action-export-frames").removeClass("disabled"),$("#action-import-data").removeClass("disabled"),$("#action-clear-frames").removeClass("disabled")})):(b.log("No frames"),b.dialog("No frames available","Playback Error"),$("#player-canvas").removeClass("loading"),$("#action-preview").removeClass("disabled"),$("#action-export-data").removeClass("disabled"),$("#action-export-frames").removeClass("disabled"),$("#action-import-data").removeClass("disabled"),$("#action-clear-frames").removeClass("disabled"))},b.loadFramesSequentially=function(a,c,d){if(b.log("Initiating sequential load"),!a.length)return void c.call();"undefined"==typeof d&&(d=a.length);var e=new Image,f=a.shift(),g=d-a.length;b.log("Loading Frame #"+g+" of "+d),$("#player-info span").text("Loading Frame #"+g+" of "+d),e.onload=function(){b.log("Frame #"+g+" loaded"),b.loadFramesSequentially(a,c,d)},e.src=f.url},b.getCoordinatesFromPostcode=function(a){var c=new $.Deferred;return b.log('Geocoding "'+a+'"'),b.geocoder.geocode({address:a},function(d,e){if(e===google.maps.GeocoderStatus.OK){b.log('Successfully geocoded "'+a+'"'),b.log("Lat: "+d[0].geometry.location.lat()),b.log("Lng: "+d[0].geometry.location.lng());var f={lat:d[0].geometry.location.lat(),lng:d[0].geometry.location.lng()};c.resolve(f)}else b.log('"'+a+'" could not be geocoded'),c.reject({error:'Failed to geocode "'+a+'".',response:d})}),c.promise()},b.getImgUrl=function(a,c,d,e,f,g,h){var i;return a=a||0,c=c||0,i="http://maps.googleapis.com/maps/api/streetview?",i+="size="+a+"x"+c,i+="&location="+d+","+e,i+="&heading="+f,i+="&pitch="+g,i+="&fov="+h,i+="&sensor=false",i+="&key="+b.apiKey,$.trim(b.apiKey).length||b.warn("Missing API Key, Streetview URL will be rejected"),i},b.playerPlay=function(a){b.playerStop(),b.log("Beginning playback"),$("#action-player-stop").show(),b.player.frames=a,b.player.currentFrame=null,b.player.instance=setInterval(function(){null===b.player.currentFrame&&(b.player.currentFrame=-1),b.player.currentFrame++;var a=b.player.currentFrame;"undefined"==typeof b.player.frames[a]&&(b.player.currentFrame=0,a=0),$("#player-canvas").css("background-image","url("+b.player.frames[a].url+")"),$("#player-info span").text("Frame #"+a)},b.player.timeout)},b.playerStop=function(){b.log("Stopping playback"),$("#player-canvas").css("background-image","none"),$("#player-info span").text("Player ready..."),$("#action-player-stop").hide(),clearInterval(b.player.instance)},b.setApiKey=function(a){return a||(a=$("#param-api-key").val().trim()),b.log("Setting API Key: "+a),b.apiKey=a,b.rebuildFrameList(),b},b.dialog=function(a,c,d){return c=c||"Dialog Title",a=a||"No message supplied",d=d||"default",alert(c+" - "+a),b.log("Dialog: "+c+" - "+a),b},b.log=function(a){"undefined"!=typeof console&&"function"==typeof console.log&&console.log(a)},b.warn=function(a){"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(a)},b.__construct()};
//# sourceMappingURL=streetviewplotter.min.js.map